(function(){'use strict';const ENABLE_LOG=!0,FRAGMENTS_BASE='../../includes/',SOURCE_PREFIX='/html',EXTRA_CANDIDATE_PATHS=['/includes/','/html/includes/','/_includes/'];function log(){if(ENABLE_LOG)console.log.apply(console,['[breadcrumb-loader]'].concat(Array.prototype.slice.call(arguments)))}function pageNameFromPath(p){if(!p)return'index';p=p.replace(/^\/+|\/+$/g,'');if(!p)return'index';return p.replace(/\//g,'_').replace(/\.html$/i,'')}function nameVariantsForPath(pathname){const raw=(pathname||'').replace(/^\/+|\/+$/g,''),segs=raw?raw.split('/').filter(Boolean):[],fullName=pageNameFromPath(pathname),variants=new Set();variants.add(fullName+'.html');/_index$/i.test(fullName)&&variants.add(fullName.replace(/_index$/i,'')+'.html');const last=segs.length?segs[segs.length-1].replace(/\.html$/i,''):'index';variants.add(last+'.html');if(last.toLowerCase()==='index'&&segs.length>=2)variants.add(segs[segs.length-2].replace(/\.html$/i,'')+'.html');variants.add('index.html');return Array.from(variants)}function candidateFragmentUrls(pathname){const names=nameVariantsForPath(pathname),candidates=[];names.forEach(n=>candidates.push(FRAGMENTS_BASE+n));EXTRA_CANDIDATE_PATHS.forEach(base=>{names.forEach(n=>candidates.push(base.replace(/\/+$/,'/')+n))});try{const origin=window.location.origin||(location.protocol+'//'+location.hostname+(location.port?':'+location.port:''));names.forEach(n=>{candidates.push(origin+'/includes/'+n);candidates.push(origin+'/html/includes/'+n);candidates.push(origin+'/_includes/'+n)})}catch(e){}names.forEach(n=>candidates.push(n));return Array.from(new Set(candidates))}function insertHtml(html){let container=document.getElementById('breadcrumb-container');if(!container){const header=document.querySelector('header');if(header){container=document.createElement('div');container.id='breadcrumb-container';header.parentNode.insertBefore(container,header.nextSibling)}else{container=document.createElement('div');container.id='breadcrumb-container';document.body.insertBefore(container,document.body.firstChild);log('header non trovato: inserito container in cima al body (fallback).')}}container.innerHTML=html;try{makeCurrentClickable(container)}catch(err){log('makeCurrentClickable error:',err&&err.message?err.message:err)}if(window.rebuildBreadcrumbs)try{window.rebuildBreadcrumbs()}catch(e){log('rebuildBreadcrumbs error',e)}if(window.onBreadcrumbsLoaded)try{window.onBreadcrumbsLoaded()}catch(e){} }function fetchFirstSuccessful(candidates){let i=0;function next(){if(i>=candidates.length)return Promise.resolve(null);const url=candidates[i++];log('Trying fragment URL:',url);return fetch(url,{cache:'no-cache'}).then(resp=>{log(' ->',url,'status',resp.status);if(!resp.ok)return next();return resp.text().then(text=>({url,text}))}).catch(err=>{log('fetch error for',url,err&&err.message?err.message:err);return next()})}return next()}function loadBreadcrumb(){const pathname=location.pathname||'/',candidates=candidateFragmentUrls(pathname);log('Candidates:',candidates);return fetchFirstSuccessful(candidates).then(found=>{if(!found){log('Nessun frammento breadcrumb trovato per',pathname);return}log('Frammento caricato da',found.url);insertHtml(found.text)}).catch(err=>log('Loader error',err))}function waitAndLoad(timeout=2500){if(document.querySelector('header'))return loadBreadcrumb();const obs=new MutationObserver((mut,o)=>{if(document.querySelector('header')){o.disconnect();log('Header trovato via MutationObserver.');loadBreadcrumb()}});obs.observe(document.documentElement,{childList:!0,subtree:!0});setTimeout(()=>{try{obs.disconnect()}catch(e){}if(!document.querySelector('header'))log('Timeout: header non trovato entro',timeout,'ms â€” procedo comunque.');loadBreadcrumb()},timeout)}'loading'===document.readyState?document.addEventListener('DOMContentLoaded',()=>waitAndLoad(2500)):waitAndLoad(2500);function makeCurrentClickable(container){if(!container)return;const current=container.querySelector('[aria-current="page"]');if(!current)return;try{if(current.tagName&&current.tagName.toLowerCase()==='a'){current.classList.add('breadcrumb-reset');return}const innerA=current.querySelector&&current.querySelector('a');if(innerA){innerA.classList.add('breadcrumb-reset');innerA.setAttribute('aria-current','page');return}const origin=(window.location&&window.location.origin)||(location.protocol+'//'+location.hostname+(location.port?':'+location.port:'')),cleanHref=origin+(window.location&&window.location.pathname?window.location.pathname:'/'),anchor=document.createElement('a');anchor.href=cleanHref;anchor.title='Reset pagina';anchor.className='breadcrumb-reset';anchor.setAttribute('aria-current','page');anchor.innerHTML=current.innerHTML||(current.textContent||'Reset');for(;current.firstChild;)current.removeChild(current.firstChild);current.appendChild(anchor)}catch(e){log('Errore durante makeCurrentClickable (non fatale):',e&&e.message?e.message:e)}}})();
